import React, { useState, useMemo, useCallback, useEffect } from "react";
import { Select } from "antd";
import { debounce, isEmpty } from "lodash";
import { useTranslation } from "react-i18next";
import { NS_FLOW_BUILDER, K } from "../../../i18n/constants";
import { useContractModels } from "../../hooks/useContractModels";
import { fetchModelData } from "../../hooks/useCurModel";
import { MoreOption } from "../more-option/MoreOption";
import { ContractContext } from "../../ContractContext";
import { ModelFieldItem } from "../../interfaces";
import {
  processRefItemData,
  processRefItemInitValue,
  getFlattenFields,
} from "../../processor";

export interface ProcessRefItemValue {
  name?: string;
  field?: string;
}

export interface RefItemProps {
  value?: string;
  onChange?: (value: string) => void;
}

export function RefItem(props: RefItemProps): React.ReactElement {
  const { t } = useTranslation(NS_FLOW_BUILDER);
  const [{ modelList }, setQ, setPageSize] = useContractModels();
  const [fieldList, setFieldList] = useState<ModelFieldItem[]>([]);
  const [refValue, setRefValue] = useState<ProcessRefItemValue>(
    processRefItemInitValue(props.value)
  );

  useEffect(() => {
    const value = processRefItemInitValue(props.value);
    setRefValue(value);
  }, [props.value]);

  useEffect(() => {
    (async () => {
      if (!refValue.name) {
        setFieldList([]);
      } else {
        const data = await fetchModelData(refValue.name);
        setFieldList(
          getFlattenFields(data?.fields, data?.importModelDefinition)
        );
      }
    })();
  }, [refValue.name]);

  const processFieldList = useCallback((fieldList: ModelFieldItem[]) => {
    if (!isEmpty(fieldList)) {
      return [{ name: "*" }].concat(fieldList);
    }

    return fieldList;
  }, []);

  const handleModelChange = (value: string): void => {
    const newValue = {
      name: value,
      field: "",
    };
    setRefValue(newValue);
    props.onChange(processRefItemData(newValue));

    const find = modelList.find((item) => item.name === value);
    // istanbul ignore else
    if (find) {
      // 放入当前的模型的定义
      const modelDefinitionList = [
        {
          name: find.name,
          fields: find.fields,
        },
        ...(find.importModelDefinition || []),
      ];
      const contractContext = ContractContext.getInstance();
      contractContext.addModelDefinition(modelDefinitionList);
      contractContext.addImportNamespace(
        find.name,
        `${find.namespaceId}.${find.name}`
      );
      setFieldList(getFlattenFields(find.fields, find?.importModelDefinition));
    }
  };

  const handleSearch = useCallback(
    (value: string): void => {
      setQ(value ?? "");
    },
    [setQ]
  );

  const debounceSearch = useMemo(() => {
    return debounce(handleSearch, 200);
  }, [handleSearch]);

  const handleFieldChange = (value: string): void => {
    const newValue = {
      ...refValue,
      field: value,
    };

    setRefValue(newValue);
    props.onChange(processRefItemData(newValue));
  };

  return (
    <div style={{ display: "flex", gap: 8 }}>
      <Select
        style={{ flex: 1 }}
        value={refValue.name}
        showSearch
        filterOption={false}
        placeholder={t(K.MODEL_SEARCH_PLACEHOLDER)}
        onChange={handleModelChange}
        onSearch={debounceSearch}
        dropdownRender={(menu) => (
          <>
            {menu}
            {modelList.length > 0 && (
              <MoreOption onChange={(pageSize) => setPageSize(pageSize)} />
            )}
          </>
        )}
      >
        {modelList.map((item) => (
          <Select.Option key={item.name} value={item.name}>
            {item.name}
          </Select.Option>
        ))}
      </Select>
      <Select
        style={{ flex: 1 }}
        onChange={handleFieldChange}
        value={refValue.field}
        placeholder={t(K.REF_FIELD_SELECT_PLACEHOLDER)}
      >
        {processFieldList(fieldList)?.map((item) => (
          <Select.Option key={item.name} value={item.name}>
            {item.name}
          </Select.Option>
        ))}
      </Select>
    </div>
  );
}
